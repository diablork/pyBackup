#!/usr/bin/env python

# Author: Florin Baca
# Date: July 2013

import sys, tarfile, os, time

if os.path.isfile('backup.conf'):
	CONF = 'backup.conf'
else:
	dir = os.path.dirname(sys.argv[0])
	CONF = str(dir) + '/' + 'backup.conf'

# Parse the config file. We are mainly
# interested to drop comments and blank
# lines.

def parseConfig(loc=CONF):
	try:
		file = open(loc, 'r')
		data = file.readlines()
		file.close()
	except:
		print "Unable to open config file: %s\nPlease retry with a valid config file." % loc
		sys.exit(1)
	conf = {}
	for line in data:
		if line.startswith('#'):
			# comments
			pass
		elif line == '\n':
			# blank line
			pass
		elif '=' in line:
			# this is one of the params
			# we can have a single value
			# or multiple values separated by ,
			if ',' in line:
				line = line.replace(' ', '')
				line = line.replace('\n', '')
				param = line.split('=')[0]
				values = line.split('=')[1:]
				values = values[0].split(',')
				conf[param] = values
			else:
				line = line.replace(' ', '')
				line = line.replace('\n', '')
				param = line.split('=')[0]
				value = line.split('=')[1]
				conf[param] = value
		else:
			pass
	return conf

def archiveFiles(dest, name, source):
	if not '.tar.gz' in name:
		name = str(name) + '.tar.gz'
	dest = str(dest) + '/' + str(name)
	if not os.path.isfile(dest):
		tarFile = tarfile.open(dest, 'w:gz')
		if isinstance(source, list):
			for path in source:
				print "Adding %s to %s" % (path, name)
				init = time.time()
				tarFile.add(path)
				end = time.time() - init
				print "Finished in %.2f" % end
		else: 
			print "Adding %s to %s" % (source, name)
			init = time.time()
			tarFile.add(source)
			end = time.time() - init
			print "Finished in %.2f" % end
		tarFile.close()
	else:
		print "[ERROR] %s already exists, please retry." % dest

def fileName():
	name = 'pyBackup' + str(time.strftime('%d%m%Y%H%M%S', time.localtime()))
	return name

def checkDir(path):
	if os.path.exists(path):
		if os.path.isfile(path):
			print "%s already exists, but it's a file. Please specify a different path" % path
			sys.exit(1)
		elif os.path.isdir(path):
			return 0
	else:
		os.mkdir(path)
		return 0
		

def main():
	params = parseConfig()
	dest = params['destination']
	checkDir(dest)
	source = params['source']
	name = fileName()
	archiveFiles(dest, name, source)

if __name__ == '__main__':
	main()
